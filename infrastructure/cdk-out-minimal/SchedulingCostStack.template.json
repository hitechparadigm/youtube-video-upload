{
 "Description": "EventBridge Scheduling and Cost Tracking Infrastructure",
 "Resources": {
  "CostTrackingTableAE126A5E": {
   "Type": "AWS::DynamoDB::Table",
   "Properties": {
    "AttributeDefinitions": [
     {
      "AttributeName": "costId",
      "AttributeType": "S"
     },
     {
      "AttributeName": "timestamp",
      "AttributeType": "S"
     },
     {
      "AttributeName": "projectId",
      "AttributeType": "S"
     },
     {
      "AttributeName": "service",
      "AttributeType": "S"
     },
     {
      "AttributeName": "date",
      "AttributeType": "S"
     }
    ],
    "BillingMode": "PAY_PER_REQUEST",
    "GlobalSecondaryIndexes": [
     {
      "IndexName": "ProjectIndex",
      "KeySchema": [
       {
        "AttributeName": "projectId",
        "KeyType": "HASH"
       },
       {
        "AttributeName": "timestamp",
        "KeyType": "RANGE"
       }
      ],
      "Projection": {
       "ProjectionType": "ALL"
      }
     },
     {
      "IndexName": "ServiceIndex",
      "KeySchema": [
       {
        "AttributeName": "service",
        "KeyType": "HASH"
       },
       {
        "AttributeName": "timestamp",
        "KeyType": "RANGE"
       }
      ],
      "Projection": {
       "ProjectionType": "ALL"
      }
     },
     {
      "IndexName": "DateIndex",
      "KeySchema": [
       {
        "AttributeName": "date",
        "KeyType": "HASH"
       },
       {
        "AttributeName": "timestamp",
        "KeyType": "RANGE"
       }
      ],
      "Projection": {
       "ProjectionType": "ALL"
      }
     }
    ],
    "KeySchema": [
     {
      "AttributeName": "costId",
      "KeyType": "HASH"
     },
     {
      "AttributeName": "timestamp",
      "KeyType": "RANGE"
     }
    ],
    "PointInTimeRecoverySpecification": {
     "PointInTimeRecoveryEnabled": true
    },
    "TableName": "automated-video-pipeline-costs",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ]
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/CostTrackingTable/Resource"
   }
  },
  "ScheduleMetadataTable59D83AC6": {
   "Type": "AWS::DynamoDB::Table",
   "Properties": {
    "AttributeDefinitions": [
     {
      "AttributeName": "topicId",
      "AttributeType": "S"
     }
    ],
    "BillingMode": "PAY_PER_REQUEST",
    "KeySchema": [
     {
      "AttributeName": "topicId",
      "KeyType": "HASH"
     }
    ],
    "TableName": "automated-video-pipeline-schedules",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ]
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/ScheduleMetadataTable/Resource"
   }
  },
  "BudgetAlertTopicF20DF526": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "Video Pipeline Budget Alerts",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "TopicName": "automated-video-pipeline-budget-alerts"
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/BudgetAlertTopic/Resource"
   }
  },
  "BudgetAlertTopicadminexamplecom79599723": {
   "Type": "AWS::SNS::Subscription",
   "Properties": {
    "Endpoint": "admin@example.com",
    "Protocol": "email",
    "TopicArn": {
     "Ref": "BudgetAlertTopicF20DF526"
    }
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/BudgetAlertTopic/admin@example.com/Resource"
   }
  },
  "ScheduleAlertTopic49D7F450": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "Video Pipeline Schedule Alerts",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "TopicName": "automated-video-pipeline-schedule-alerts"
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/ScheduleAlertTopic/Resource"
   }
  },
  "EventBridgeSchedulerServiceRole9AA0C57A": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ],
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/EventBridgeScheduler/ServiceRole/Resource"
   }
  },
  "EventBridgeSchedulerServiceRoleDefaultPolicy2AF47854": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "events:DeleteRule",
        "events:DescribeRule",
        "events:ListRules",
        "events:PutRule",
        "events:PutTargets",
        "events:RemoveTargets"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": "lambda:InvokeFunction",
       "Effect": "Allow",
       "Resource": {
        "Fn::ImportValue": "VideoPipelineStack:ExportsOutputFnGetAttWorkflowOrchestratorFunction392225F6Arn14258EF4"
       }
      },
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:ConditionCheckItem",
        "dynamodb:DeleteItem",
        "dynamodb:DescribeTable",
        "dynamodb:GetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:PutItem",
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:UpdateItem"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "ScheduleMetadataTable59D83AC6",
          "Arn"
         ]
        },
        {
         "Ref": "AWS::NoValue"
        }
       ]
      },
      {
       "Action": "sns:Publish",
       "Effect": "Allow",
       "Resource": {
        "Ref": "ScheduleAlertTopic49D7F450"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "EventBridgeSchedulerServiceRoleDefaultPolicy2AF47854",
    "Roles": [
     {
      "Ref": "EventBridgeSchedulerServiceRole9AA0C57A"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/EventBridgeScheduler/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "EventBridgeSchedulerD7961FBE": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-786673323159-us-east-1",
     "S3Key": "2a803b2636dee9a72dcd58821f3929813de40b333b8651ac85dffb44cf56b0b5.zip"
    },
    "Environment": {
     "Variables": {
      "TOPICS_TABLE": {
       "Fn::ImportValue": "VideoPipelineStack:ExportsOutputRefTopicsTableB8A0263C8384981D"
      },
      "SCHEDULE_METADATA_TABLE": {
       "Ref": "ScheduleMetadataTable59D83AC6"
      },
      "WORKFLOW_ORCHESTRATOR_ARN": {
       "Fn::ImportValue": "VideoPipelineStack:ExportsOutputFnGetAttWorkflowOrchestratorFunction392225F6Arn14258EF4"
      },
      "AWS_ACCOUNT_ID": "786673323159",
      "SCHEDULE_ALERT_TOPIC_ARN": {
       "Ref": "ScheduleAlertTopic49D7F450"
      }
     }
    },
    "FunctionName": "automated-video-pipeline-eventbridge-scheduler",
    "Handler": "index.handler",
    "Layers": [
     {
      "Fn::ImportValue": "VideoPipelineStack:ExportsOutputRefContextLayerBFE43D6898EF3E60"
     }
    ],
    "MemorySize": 512,
    "Role": {
     "Fn::GetAtt": [
      "EventBridgeSchedulerServiceRole9AA0C57A",
      "Arn"
     ]
    },
    "Runtime": "nodejs20.x",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "Timeout": 25
   },
   "DependsOn": [
    "EventBridgeSchedulerServiceRoleDefaultPolicy2AF47854",
    "EventBridgeSchedulerServiceRole9AA0C57A"
   ],
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/EventBridgeScheduler/Resource",
    "aws:asset:path": "asset.2a803b2636dee9a72dcd58821f3929813de40b333b8651ac85dffb44cf56b0b5",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "CostTrackerServiceRole60A50DAB": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ],
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/CostTracker/ServiceRole/Resource"
   }
  },
  "CostTrackerServiceRoleDefaultPolicy7E8160A9": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ce:GetCostAndUsage",
        "ce:GetDimensionValues",
        "ce:GetReservationCoverage",
        "ce:GetReservationPurchaseRecommendation",
        "ce:GetReservationUtilization",
        "ce:GetUsageReport",
        "cloudwatch:GetMetricStatistics",
        "cloudwatch:PutMetricData"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:ConditionCheckItem",
        "dynamodb:DeleteItem",
        "dynamodb:DescribeTable",
        "dynamodb:GetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:PutItem",
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:UpdateItem"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "CostTrackingTableAE126A5E",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "CostTrackingTableAE126A5E",
             "Arn"
            ]
           },
           "/index/*"
          ]
         ]
        }
       ]
      },
      {
       "Action": "sns:Publish",
       "Effect": "Allow",
       "Resource": {
        "Ref": "BudgetAlertTopicF20DF526"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "CostTrackerServiceRoleDefaultPolicy7E8160A9",
    "Roles": [
     {
      "Ref": "CostTrackerServiceRole60A50DAB"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/CostTracker/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "CostTracker717CD556": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-786673323159-us-east-1",
     "S3Key": "73a1966bc6ac823985c049b42ecd29083ed8cfee26af28262f542de96984e422.zip"
    },
    "Environment": {
     "Variables": {
      "COST_TRACKING_TABLE": {
       "Ref": "CostTrackingTableAE126A5E"
      },
      "BUDGET_ALERT_TOPIC_ARN": {
       "Ref": "BudgetAlertTopicF20DF526"
      },
      "SCHEDULE_ALERT_TOPIC_ARN": {
       "Ref": "ScheduleAlertTopic49D7F450"
      }
     }
    },
    "FunctionName": "automated-video-pipeline-cost-tracker",
    "Handler": "index.handler",
    "Layers": [
     {
      "Fn::ImportValue": "VideoPipelineStack:ExportsOutputRefContextLayerBFE43D6898EF3E60"
     }
    ],
    "MemorySize": 512,
    "Role": {
     "Fn::GetAtt": [
      "CostTrackerServiceRole60A50DAB",
      "Arn"
     ]
    },
    "Runtime": "nodejs20.x",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "Timeout": 25
   },
   "DependsOn": [
    "CostTrackerServiceRoleDefaultPolicy7E8160A9",
    "CostTrackerServiceRole60A50DAB"
   ],
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/CostTracker/Resource",
    "aws:asset:path": "asset.73a1966bc6ac823985c049b42ecd29083ed8cfee26af28262f542de96984e422",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "HighCostAlarmD18CE0E9": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "BudgetAlertTopicF20DF526"
     }
    ],
    "AlarmDescription": "Alert when video production costs exceed threshold",
    "AlarmName": "video-pipeline-high-cost",
    "ComparisonOperator": "GreaterThanThreshold",
    "EvaluationPeriods": 2,
    "MetricName": "TotalCost",
    "Namespace": "AutomatedVideoPipeline/Costs",
    "Period": 300,
    "Statistic": "Sum",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "Threshold": 5
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/HighCostAlarm/Resource"
   }
  },
  "ScheduleFailureAlarm1355948B": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "ScheduleAlertTopic49D7F450"
     }
    ],
    "AlarmDescription": "Alert when scheduled video generation fails",
    "AlarmName": "video-pipeline-schedule-failures",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": {
       "Ref": "EventBridgeSchedulerD7961FBE"
      }
     }
    ],
    "EvaluationPeriods": 2,
    "MetricName": "Errors",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "Threshold": 3
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/ScheduleFailureAlarm/Resource"
   }
  },
  "DailyCostReportRuleBD990DD4": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "Description": "Generate daily cost reports",
    "Name": "daily-cost-report",
    "ScheduleExpression": "cron(0 9 * * ? *)",
    "State": "ENABLED",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "CostTracker717CD556",
        "Arn"
       ]
      },
      "Id": "Target0"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/DailyCostReportRule/Resource"
   }
  },
  "DailyCostReportRuleAllowEventRuleSchedulingCostStackCostTrackerA52DD531E64A6C57": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "CostTracker717CD556",
      "Arn"
     ]
    },
    "Principal": "events.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "DailyCostReportRuleBD990DD4",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/DailyCostReportRule/AllowEventRuleSchedulingCostStackCostTrackerA52DD531"
   }
  },
  "WeeklyOptimizationRule95971927": {
   "Type": "AWS::Events::Rule",
   "Properties": {
    "Description": "Optimize schedules based on performance data",
    "Name": "weekly-schedule-optimization",
    "ScheduleExpression": "cron(0 8 ? * 1 *)",
    "State": "ENABLED",
    "Tags": [
     {
      "Key": "Environment",
      "Value": "production"
     },
     {
      "Key": "ManagedBy",
      "Value": "github-actions"
     },
     {
      "Key": "Owner",
      "Value": "video-automation-team"
     },
     {
      "Key": "Project",
      "Value": "automated-video-pipeline"
     }
    ],
    "Targets": [
     {
      "Arn": {
       "Fn::GetAtt": [
        "EventBridgeSchedulerD7961FBE",
        "Arn"
       ]
      },
      "Id": "Target0"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/WeeklyOptimizationRule/Resource"
   }
  },
  "WeeklyOptimizationRuleAllowEventRuleSchedulingCostStackEventBridgeSchedulerAA2F7DE410530BAF": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "EventBridgeSchedulerD7961FBE",
      "Arn"
     ]
    },
    "Principal": "events.amazonaws.com",
    "SourceArn": {
     "Fn::GetAtt": [
      "WeeklyOptimizationRule95971927",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/WeeklyOptimizationRule/AllowEventRuleSchedulingCostStackEventBridgeSchedulerAA2F7DE4"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/02NzW7CMBCEn4W7sw3h1CNU4owS7mhjb+kS/6CsTYQsv3sV00qc5tvRzE4H3fYT2g0u0mgzNZZHyENEPameJKRZk8JFLtk8PbpgRshnHC2pr29foSjxAvkc7qyrWWFIo+iZ75GDX933uyiLbjQI+Zi8/k+884lmxyI1y+gg9+G1WPUULOtnzVUqSnYXFKEosF9FyQ4OSU8UDyiktA3JLBj1D+S9xdmt1QpF0YN8FMh9+htIlkpR9c0Q8cr+WpQPhuAmH4+ug66FdnMT5mZOPrIj6F/6C158bPtJAQAA"
   },
   "Metadata": {
    "aws:cdk:path": "SchedulingCostStack/CDKMetadata/Default"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}